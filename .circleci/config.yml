### AUTO GENERATED. DO NOT MODIFY. ###
# This file should be auto generated by the files in the src folder.
# You can update it by running `./scripts/circleci-update-config` from the project root.
commands:
    check_circleci_config:
        description: This command builds the circle config from the files in src and validates that it is up-to-date and valid.
        steps:
            - run:
                command: curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash
                name: Install CircleCI CLI
            - run:
                command: ./scripts/circleci-update-config
                name: Build circle config
            - run:
                command: |
                    FILES_MODIFIED=""
                    setcommit () {
                      FILES_MODIFIED=$(git status -s | grep -i -E '.*circleci/config.yml')
                    }
                    setcommit || true
                    if [ -z "$FILES_MODIFIED" ]
                    then
                      echo "The CircleCI config is up to date."
                      exit 0;
                    else
                      echo "The CircleCI config is not up to date. You can update it by running the `./scripts/circleci-update-config` script."
                      exit 1;
                    fi
                name: CircleCI config up to date
            - run:
                command: circleci config validate
                name: Validate circle config
    fetch_supported_versions:
        description: Fetch supported versions from Cloud
        steps:
            - run:
                command: sh ./scripts/fetch-supported-versions.sh
                name: Fetch supported versions from Cloud
            - store_artifacts:
                path: ./app-supportedversions.json
    install_fastlane:
        description: Restores and saves fastlane cache of the passed directory.
        parameters:
            directory:
                type: string
        steps:
            - restore_cache:
                keys: bundle-v1-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                name: Restore gems cache
            - run:
                command: bundle config set path 'vendor/bundle'
                name: Configure Installation Directory
                working_directory: << parameters.directory >>
            - run:
                command: bundle check || bundle install
                name: Bundle Install
                working_directory: << parameters.directory >>
            - save_cache:
                key: bundle-v1-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                name: Save gems cache
                paths:
                    - << parameters.directory >>/vendor/bundle
    install_node_modules:
        description: Restores and saves the node_modules directories of the tools directory.
        steps:
            - restore_cache:
                key: node-modules-{{ checksum "yarn.lock" }}
                name: Restore NPM cache
            - run:
                command: |
                    yarn global add node-gyp
                    yarn
                name: Install NPM modules
            - save_cache:
                key: node-modules-{{ checksum "yarn.lock" }}
                name: Save NPM cache
                paths:
                    - ./node_modules
    install_pods:
        description: Restore/Get/Save cache of pods libs
        steps:
            - restore_cache:
                key: pods-v1-{{ checksum "ios/Podfile.lock" }}
                name: Restore pods
            - run:
                command: bundle exec pod install --deployment
                name: Install pods
                working_directory: ios
            - save_cache:
                key: pods-v1-{{ checksum "ios/Podfile.lock" }}
                name: Save pods specs and pods cache
                paths:
                    - ~/.pods
                    - ios/Pods
    persist_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ${BASH_ENV}
                name: List environment variables
            - run:
                command: cat ${BASH_ENV} >> environment_variables
                name: Save environment variables to file
            - persist_to_workspace:
                paths:
                    - environment_variables
                root: ./
    prepare_workspace:
        description: Attach the workspace at ~/attached_workspace and list its contents
        steps:
            - attach_workspace:
                at: ~/attached_workspace
            - run:
                command: ls -A ~/attached_workspace
                name: Attached workspace contents
            - run:
                command: ls -AR ~/attached_workspace
                name: Recursively list attached workspace contents
    restore_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ~/attached_workspace/environment_variables
                name: List environment variables
            - run:
                command: cat ~/attached_workspace/environment_variables >> ${BASH_ENV}
                name: Restore environment variables
jobs:
    build_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
            GRADLE_OPTS: -Xmx3g -XX:+HeapDumpOnOutOfMemoryError"
        resource_class: large
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - prepare_workspace
            - restore_environment_variables
            - fetch_supported_versions
            - install_node_modules
            - restore_cache:
                key: android-{{ checksum "android/build.gradle" }}-{{ checksum  "android/app/build.gradle" }}
                name: Restore gradle cache
            - install_fastlane:
                directory: android
            - run:
                command: bundle exec fastlane android keystore
                name: '[FL] Prepare Android Keystore'
                working_directory: android
            - run:
                command: bundle exec fastlane android build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Build'
                working_directory: android
            - run:
                command: mv ~/project/build/app/outputs/bundle/release/app-release.aab app-release.aab
                name: Move aab
            - store_artifacts:
                path: app-release.aab
            - run:
                command: mv ~/project/build/app/outputs/apk/release/app-release.apk app-release.apk
                name: Move apk
            - store_artifacts:
                path: app-release.apk
            - persist_to_workspace:
                paths:
                    - app-release.aab
                    - app-release.apk
                root: .
            - save_cache:
                key: android-{{ checksum "android/build.gradle" }}-{{ checksum  "android/app/build.gradle" }}
                name: Save gradle cache
                paths:
                    - ~/.gradle
            - persist_environment_variables
    build_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 16.1.0
        steps:
            - checkout
            - prepare_workspace
            - restore_environment_variables
            - fetch-supported-versions
            - install_node_modules
            - install_pods
            - install_fastlane:
                directory: ios
            - run:
                command: bundle exec fastlane ios build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Build'
                working_directory: ios
            - store_artifacts:
                destination: app-release.ipa
                path: ~/app-release.ipa
            - persist_to_workspace:
                paths:
                    - app-release.ipa
                root: ~/
    bump_version:
        docker:
            - image: cimg/node:20.13.1
        parameters:
            prepare_delivery:
                default: false
                description: Whether to prepare for a delivery. If true, the version bump is committed.
                type: boolean
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - install_node_modules
            - run:
                command: echo "export NEW_VERSION_NAME='2025.3.1'" >> ${BASH_ENV}
                name: Calculate next version name
                working_directory: tools
            - run:
                command: echo "export NEW_VERSION_CODE=1" >> ${BASH_ENV}
                name: Calculate next version code
                working_directory: tools
            - when:
                condition: << parameters.prepare_delivery >>
                steps:
                    - run:
                        command: yarn git-version bump-to ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --github-private-key ${GITHUB_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH}
                        name: Bump git version
                        working_directory: tools
            - persist_environment_variables
    deliver_android:
        docker:
            - image: cimg/android:2024.08.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - prepare_workspace
            - restore_environment_variables
            - install_node_modules
            - install_fastlane:
                directory: android
            - run:
                command: bundle exec fastlane android upload aab_path:attached_workspace/app-release.aab production_delivery:"<< parameters.production_delivery >>" version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Google PlayStore Upload'
                working_directory: android
            - run:
                command: echo "export ANDROID_RELEASE_ID='$(yarn --silent github-release create android ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --production-delivery << parameters.production_delivery >> --github-private-key ${GITHUB_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --release-notes "Release v${NEW_VERSION_NAME}+${NEW_VERSION_CODE}")'" >> ${BASH_ENV}
                name: Create Github Release
                working_directory: tools
            - run:
                command: yarn github-release-asset upload android --releaseId ${ANDROID_RELEASE_ID} --files "$(ls ~/attached_workspace/*.{apk,aab})" --github-private-key ${GITHUB_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Add Builds to Github Release
                working_directory: tools
    deliver_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 16.1.0
        parameters:
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        steps:
            - checkout
            - prepare_workspace
            - restore_environment_variables
            - install_node_modules
            - install_fastlane:
                directory: ios
            - when:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios production_upload ipa_path:attached_workspace/app-release.ipa version_name:${NEW_VERSION_NAME}
                        name: '[FL] Apple AppStore Upload'
                        working_directory: ios
            - unless:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios beta_upload ipa_path:attached_workspace/app-release.ipa
                        name: '[FL] Apple Testflight Upload'
                        working_directory: ios
            - run:
                command: echo "export IOS_RELEASE_ID='$(yarn --silent github-release create ios ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --production-delivery << parameters.production_delivery >> --github-private-key ${GITHUB_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --release-notes "Release v${NEW_VERSION_NAME}+${NEW_VERSION_CODE}")'" >> ${BASH_ENV}
                name: Create Github Release
                working_directory: tools
            - run:
                command: yarn github-release-asset upload ios --releaseId ${IOS_RELEASE_ID} --files "$(ls ~/attached_workspace/*.ipa)" --github-private-key ${GITHUB_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Add Build to Github Release
                working_directory: tools
parameters:
    api_triggered:
        default: false
        description: Whether the pipeline was triggered through the CircleCi API (https://circleci.com/docs/api/v2/?shell#trigger-a-new-pipeline).
        type: boolean
    workflow_type:
        default: none
        enum:
            - delivery
            - none
        type: enum
version: 2.1
workflows:
    commit:
        jobs:
            - bump_version
            - build_android:
                context:
                    - app_signing_android
                requires:
                    - bump_version
        unless: << pipeline.parameters.api_triggered >>
    delivery:
        jobs:
            - bump_version:
                context:
                    - github
                prepare_delivery: true
            - build_android:
                context:
                    - app_signing_android
                requires:
                    - bump_version
            - deliver_android:
                context:
                    - github
                    - gruene_google_playstore
                production_delivery: true
                requires:
                    - build_android
            - build_ios:
                context:
                    - app_signing_ios
                requires:
                    - bump_version
            - deliver_ios:
                context:
                    - github
                    - gruene_apple_appstore
                production_delivery: true
                requires:
                    - build_ios
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - production_delivery

